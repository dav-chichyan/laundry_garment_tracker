<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Admin Dashboard - Staff Performance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bs-primary: #6c757d;
            --bs-primary-rgb: 108, 117, 125;
            --bs-border-radius: 0.5rem;
            --bs-box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --bs-box-shadow-lg: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        body {
            font-size: 0.875rem;
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.5;
        }
        
        .feather {
            width: 16px;
            height: 16px;
            vertical-align: text-bottom;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            width: 16.666667%;
            background-color: #ffffff;
            border-right: 1px solid #e9ecef;
        }
        
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: 1rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .sidebar .nav-link {
            font-weight: 500;
            color: #6c757d;
            padding: 0.75rem 1rem;
            border-radius: var(--bs-border-radius);
            margin: 0.25rem 0.5rem;
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        
        .sidebar .nav-link:hover {
            background-color: #f8f9fa;
            color: #495057;
            transform: translateX(3px);
        }
        
        .sidebar .nav-link.active {
            color: #495057;
            background-color: #e9ecef;
            font-weight: 600;
        }
        
        .sidebar .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 60%;
            background-color: #6c757d;
            border-radius: 0 2px 2px 0;
        }
        
        .sidebar .nav-link .feather {
            margin-right: 0.5rem;
            color: #6c757d;
            width: 16px;
            height: 16px;
        }
        
        .sidebar .nav-link:hover .feather,
        .sidebar .nav-link.active .feather {
            color: inherit;
        }
        
        .sidebar-heading {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        /* Navbar */
        .navbar-brand {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            background-color: rgba(0, 0, 0, .25);
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .25);
        }
        
        .navbar .navbar-toggler {
            top: 0.25rem;
            right: 1rem;
        }
        
        .navbar .form-control {
            padding: 0.75rem 1rem;
            border-width: 0;
            border-radius: 0;
        }
        
        .form-control-dark {
            color: #fff;
            background-color: rgba(255, 255, 255, .1);
            border-color: rgba(255, 255, 255, .1);
        }
        
        .form-control-dark:focus {
            border-color: transparent;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, .25);
        }
        
        /* Main content */
        .main {
            padding-top: 1.5rem;
            margin-left: 16.666667%;
            min-height: calc(100vh - 48px);
        }
        
        /* Responsive adjustments */
        @media (max-width: 767.98px) {
            .sidebar {
                width: 100%;
                position: relative;
            }
            .main {
                margin-left: 0;
            }
        }
        
        /* Cards */
        .card {
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
            border-radius: var(--bs-border-radius);
            box-shadow: var(--bs-box-shadow);
            transition: all 0.2s ease-in-out;
            background-color: #ffffff;
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: var(--bs-box-shadow-lg);
            transform: translateY(-2px);
            border-color: #dee2e6;
        }
        
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            border-radius: var(--bs-border-radius) var(--bs-border-radius) 0 0;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }
        
        .department-stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .department-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
        }

        /* Department details count badge (aligned) */
        .dept-card { border-radius: 12px; }
        .dept-card .card-body { min-height: 120px; }
        .dept-badge {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.05rem;
            box-shadow: 0 6px 14px rgba(13,110,253,.25);
        }

        .quantity-badge {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            line-height: 80px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Tables */
        .table-responsive {
            margin-bottom: 1rem;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            background-color: #f8f9fa;
        }
        
        .table td {
            vertical-align: middle;
        }

        /* Fit table without horizontal scrollbar */
        .table-responsive { overflow-x: visible !important; }
        #staffPerformanceTable.staff-table { font-size: 0.82rem; table-layout: auto; }
        #staffPerformanceTable.staff-table th, 
        #staffPerformanceTable.staff-table td { padding: 0.34rem 0.44rem; }
        #staffPerformanceTable.staff-table .btn { padding: 0.20rem 0.50rem; font-size: 0.78rem; }
        #staffPerformanceTable.staff-table th span { font-size: 0.84rem; }
        
        /* Department cards hover effect */
        .card:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease;
        }
        
        /* Table hover effects */
        .table tbody tr:hover {
            background-color: #f8f9fa !important;
        }
        
        /* Sortable table headers */
        .sortable {
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: rgba(13, 110, 253, 0.1) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .sortable i {
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .sortable:hover i {
            color: #0d6efd !important;
            transform: scale(1.1);
        }
        
        .sortable i.fa-sort-up {
            color: #198754 !important;
        }
        
        .sortable i.fa-sort-down {
            color: #dc3545 !important;
        }
        
        .sortable:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Sort info styling */
        #sortInfo {
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
            font-size: 0.875rem;
        }
        
        #currentSortInfo {
            color: #007B55;
            font-weight: 500;
        }
        
        #currentSortInfo button {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        #currentSortInfo button:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        /* Department sidebar */
        .dept-sidebar {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .dept-item {
            transition: all 0.3s ease;
        }
        
        .dept-link {
            background-color: #ffffff;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
        }
        
        .dept-link:hover {
            background-color: #f8f9fa;
            border-left-color: #007bff;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .dept-link:active {
            background-color: #e9ecef;
        }
        
        .dept-name {
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }
        
        .quantity-badge {
            background-color: #FFD700;
            color: #000;
            padding: 6px 10px;
            border-radius: 16px;
            font-weight: bold;
            font-size: 1rem;
            min-width: 35px;
            text-align: center;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .dept-info small {
            font-size: 0.8rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 767.98px) {
            .sidebar {
                top: 5rem;
            }
        }
        
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }
        
        /* Date Filter Styles */
        .date-filter-card {
            border: 1px solid #e3e6f0;
            border-radius: 0.35rem;
        }
        
        .date-filter-card .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
        }
        
        .date-filter-card .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #5a5c69;
            margin-bottom: 0.5rem;
        }
        
        .date-filter-card .btn {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
        
        .date-filter-card .form-control {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
        
        .filter-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        /* Returns link hover effect */
        .returns-btn {
            background-color: #dc3545;
            border-color: #dc3545;
            color: #fff;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 0 0 rgba(220,53,69,0);
            min-width: 36px;
        }
        .returns-btn:hover {
            background-image: linear-gradient(135deg, #e55363 0%, #dc3545 60%, #c82333 100%);
            color: #fff;
            font-weight: 700;
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(220,53,69,.35);
            text-decoration: none;
        }

        /* Department count coloring */
        .dept-btn { min-width: 40px; font-weight: 600; transition: all .15s ease; }
        .btn-dept-zero { border-color: #6c757d; color: #6c757d; background-color: transparent; }
        .btn-dept-zero:hover { background-color: rgba(108,117,125,.12); color: #6c757d; }
        .btn-dept-low { background-color: #fd7e14; border-color: #fd7e14; color: #fff; }
        .btn-dept-low:hover { background-color: #f76707; border-color: #f76707; color: #fff; box-shadow: 0 6px 14px rgba(253,126,20,.35); }
        .btn-dept-high { background-color: #198754; border-color: #198754; color: #fff; }
        .btn-dept-high:hover { background-color: #157347; border-color: #146c43; color: #fff; box-shadow: 0 6px 14px rgba(25,135,84,.35); }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-2 me-0 px-3" href="javascript:void(0)">Maqoor Admin</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-nav">
            <div class="nav-item text-nowrap">
                <a class="nav-link px-3" href="/auth/logout">Sign out</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Navigation -->
            <nav id="sidebarMenu" class="col-md-2 d-md-block bg-light sidebar collapse">
                <div class="sidebar-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin/users">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/orders/search">
                                <i class="fas fa-search me-2"></i>
                                Order Search
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/users-management">
                                <i class="fas fa-users me-2"></i>
                                User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/task-management">
                                <i class="fas fa-tasks me-2"></i>
                                Task Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/scanned-garments">
                                <i class="fas fa-barcode me-2"></i>
                                Scanned Garments
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/returns-dashboard">
                                <i class="fas fa-undo me-2"></i>
                                Returns Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/problems">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Problems
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/departments">
                                <i class="fas fa-building me-2"></i>
                                Departments
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main role="main" class="col-md-10 px-md-4 main">
                <!-- Success/Error Messages -->
                <div th:if="${msg != null}" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                    <span th:text="${msg}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Page Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <div class="col">
                        <h1 class="h2 d-flex align-items-center">
                            <img src="/logo.png" alt="Maqoor" class="me-2" style="height:32px; width:auto;">
                            <span>Staff Performance Dashboard</span>
                        </h1>
                        <p class="text-muted">Monitor staff performance and department statistics</p>
                    </div>
                
                </div>

                

                <!-- Date Filters -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    Date Range Filter
                                </h6>
                            </div>
                            <div class="card-body">
                                <form th:action="@{/admin/users}" method="get" class="row g-3 align-items-end">
                                    <div class="col-md-2">
                                        <label for="today" class="form-label">Quick Filters</label>
                                        <div class="d-grid gap-2">
                                            <button type="submit" name="filter" value="today" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-calendar-day me-1"></i> Today
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid gap-2">
                                            <button type="submit" name="filter" value="yesterday" class="btn btn-outline-secondary btn-sm">
                                                <i class="fas fa-calendar-minus me-1"></i> Yesterday
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="fromDate" class="form-label">From Date</label>
                                        <input type="datetime-local" class="form-control form-control-sm" id="fromDate" name="fromDate" 
                                               th:value="${from}" th:min="'2020-01-01T00:00'" th:max="'2030-12-31T23:59'" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="toDate" class="form-label">To Date</label>
                                        <input type="datetime-local" class="form-control form-control-sm" id="toDate" name="toDate" 
                                               th:value="${to}" th:min="'2020-01-01T00:00'" th:max="'2030-12-31T23:59'" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="fas fa-search me-1"></i> Apply Filter
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid gap-2">
                                            <a th:href="@{/admin/users}" class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-times me-1"></i> Clear
                                            </a>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Performance Table -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Staff Performance
                                </h5>
                                <button class="btn btn-success btn-sm" onclick="exportTableToCSV()">
                                    <i class="fas fa-file-csv me-2"></i>Export CSV
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-hover align-middle text-center staff-table" id="staffPerformanceTable">
                                        <thead>
                                        <tr class="table-light">
                                            <th class="sortable position-relative" data-sort="name" style="cursor: pointer;" title="Click to sort by Name">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <span>Name</span>
                                                    <i class="fa-solid fa-sort text-muted"></i>
                                                </div>
                                            </th>
                                            <th class="sortable position-relative" data-sort="totalScans" style="cursor: pointer;" title="Click to sort by Total Scans">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <span>Total Scans</span>
                                                    <i class="fa-solid fa-sort text-muted"></i>
                                                </div>
                                            </th>
                                            <th th:each="dept : ${departments}" th:if="${dept != T(com.chich.maqoor.entity.constant.Departments).PACKAGING and dept != T(com.chich.maqoor.entity.constant.Departments).LOCKER}" class="sortable position-relative" th:data-sort="${'dept_' + dept}" style="cursor: pointer;" th:title="'Click to sort by ' + ${dept}">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <span th:text="${#strings.equals(dept.name(),'STAIN_REMOVAL') ? 'STAIN' : (#strings.equals(dept.name(),'DRY_CLEANING') ? 'DRY' : dept)}">Department</span>
                                                    <i class="fa-solid fa-sort text-muted"></i>
                                                </div>
                                            </th>
                                            <th class="sortable position-relative" data-sort="returns" style="cursor: pointer;" title="Click to sort by Returns">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <span>Returns</span>
                                                    <i class="fa-solid fa-sort text-muted"></i>
                                                </div>
                                            </th>
                                            
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="user : ${users}">
                                            <td>
                                                <a th:href="@{'/admin/users/' + ${user.id}}" th:text="${user.name}" style="color: #007B55; text-decoration: none;">Name</a>
                                            </td>
                                            <td>
                                                <a th:href="@{'/admin/scanned-garments?userId=' + ${user.id}}" class="btn btn-info btn-sm">
                                                    <i class="fas fa-barcode"></i>
                                                    <span th:text="${scansByUser.get(user.id) != null ? scansByUser.get(user.id) : 0}">0</span>
                                                </a>
                                            </td>
                                            <td th:each="dept : ${departments}" th:if="${dept != T(com.chich.maqoor.entity.constant.Departments).PACKAGING and dept != T(com.chich.maqoor.entity.constant.Departments).LOCKER}">
                                                <a th:with="val=${userDeptCounts.get(user.id) != null ? userDeptCounts.get(user.id).get(dept) : 0}"
                                                   th:href="@{'/admin/scanned-garments?userId=' + ${user.id} + '&department=' + ${dept}}" 
                                                   class="btn btn-sm dept-btn"
                                                   th:classappend="${val == 0} ? ' btn-dept-zero' : (${val} < 100 ? ' btn-dept-low' : ' btn-dept-high')"
                                                   th:title="'View ' + ${dept} + ' scans for ' + ${user.name}">
                                                    <span th:text="${val}">0</span>
                                                </a>
                                            </td>
                                            <td>
                                                <a th:href="@{'/admin/returns-dashboard?userId=' + ${user.id} + '&fromDate=' + ${from} + '&toDate=' + ${to}}" class="btn btn-danger btn-sm returns-btn">
                                                    <span th:text="${returnsByUser.get(user.id) != null ? returnsByUser.get(user.id) : 0}">0</span>
                                                </a>
                                            </td>
                                            
                                        </tr>
                                        </tbody>
                                    </table>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Performance Horizontal Bar Chart -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Staff Performance (Chart)
                                </h5>
                            </div>
                            <div class="card-body">
                                <canvas id="staffPerfChart" height="220"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                
            </main>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetPasswordModalLabel">Reset Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="resetPasswordForm">
                        <input type="hidden" id="resetUserId">
                        <div class="mb-3">
                            <label for="resetUserName" class="form-label">User Name</label>
                            <input type="text" class="form-control" id="resetUserName" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="confirmPasswordReset()">Reset Password</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="successToastBody">
                Operation completed successfully!
            </div>
        </div>
        
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="errorToastBody">
                An error occurred!
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editUserName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="editUserName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editUserEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editUserEmail" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editUserRole" class="form-label">Role</label>
                                <select class="form-select" id="editUserRole" required>
                                    <option value="USER">User</option>
                                    <option value="ADMIN">Admin</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editUserDepartment" class="form-label">Department</label>
                                <select class="form-select" id="editUserDepartment" required>
                                    <option value="RECEPTION">Reception</option>
                                    <option value="EXAMINATION">Examination</option>
                                    <option value="WASHING">Washing</option>
                                    <option value="STAIN_REMOVAL">Stain Removal</option>
                                    <option value="DRY_CLEANING">Dry Cleaning</option>
                                    <option value="SHOES">Shoes</option>
                                    <option value="IRONING">Ironing</option>
                                    <option value="PACKAGING">Packaging</option>
                                    <option value="DELIVERY">Delivery</option>
                                    <option value="LOCKER">Locker</option>
                                    <option value="ALTERATION">Alteration</option>
                                    <option value="FINISHING">Finishing</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editUserSchedule" class="form-label">Schedule Times (comma separated)</label>
                            <input type="text" class="form-control" id="editUserSchedule" placeholder="09:00, 13:00, 17:00">
                            <small class="form-text text-muted">Enter times in 24-hour format, separated by commas (e.g., 09:00, 13:00, 17:00)</small>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Changes to user role and department will take effect immediately. Schedule times are optional.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetPasswordModalLabel">Reset Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="resetPasswordForm">
                        <input type="hidden" id="resetUserId">
                        <div class="mb-3">
                            <label for="resetUserName" class="form-label">User</label>
                            <input type="text" class="form-control" id="resetUserName" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Warning:</strong> This will immediately change the user's password. Make sure to communicate the new password securely to the user.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmPasswordReset()">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Simple date formatting for the new simplified filter form
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates if not already set
            const fromInput = document.querySelector('#fromDate');
            const toInput = document.querySelector('#toDate');
            
            if (fromInput && toInput && !fromInput.value && !toInput.value) {
                const now = new Date();
                const yesterday = new Date(now.getTime() - (24 * 60 * 60 * 1000));
                
                // Format for date input
                fromInput.value = yesterday.toISOString().slice(0, 10);
                toInput.value = now.toISOString().slice(0, 10);
            }
        });
        
        // Filter functions
        function setFilter(type) {
            const fromInput = document.querySelector('#fromDate');
            const toInput = document.querySelector('#toDate');
            
            if (!fromInput || !toInput) return;
            
            const now = new Date();
            let fromDate, toDate;
            
            switch(type) {
                case 'today':
                    fromDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    toDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'yesterday':
                    fromDate = new Date(now.getTime() - (24 * 60 * 60 * 1000));
                    toDate = new Date(now.getTime() - (24 * 60 * 60 * 1000));
                    break;
                default:
                    return;
            }
            
            fromInput.value = fromDate.toISOString().slice(0, 10);
            toInput.value = toDate.toISOString().slice(0, 10);
            
            // Auto-submit the form
            submitFilter();
        }
        
        function applyCustomRange() {
            submitFilter();
        }
        
        function submitFilter() {
            const fromInput = document.querySelector('#fromDate');
            const toInput = document.querySelector('#toDate');
            
            if (fromInput && toInput && fromInput.value && toInput.value) {
                // Convert date to datetime format for the controller
                const fromDate = fromInput.value + 'T00:00';
                const toDate = toInput.value + 'T23:59';
                
                // Redirect with the filter parameters
                window.location.href = `/admin/users?fromDate=${fromDate}&toDate=${toDate}`;
            }
        }

        // Minimal sorting implementation (3-state per column)
        let currentSort = { column: null, state: 0 }; // 0: none, 1: desc (High→Low), 2: asc (Low→High)

        document.addEventListener('DOMContentLoaded', function() {
            initSorting();
            setupUserManagement();

            const table = document.getElementById('staffPerformanceTable');
            if (table) {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach((row, idx) => row.setAttribute('data-original-index', String(idx)));
            }
        });

        function initSorting() {
            const headers = document.querySelectorAll('#staffPerformanceTable th.sortable');
            headers.forEach(h => {
                h.addEventListener('click', () => handleHeaderClick(h));
                setHeaderArrow(h, 'none');
            });
        }

        function handleHeaderClick(header) {
            const sortKey = header.getAttribute('data-sort');
            if (!sortKey) return;

            if (currentSort.column !== sortKey) {
                // New column: start at state 1 (desc / High→Low)
                currentSort = { column: sortKey, state: 1 };
            } else {
                // Same column: advance state 1 → 2 → 0
                currentSort.state = (currentSort.state + 1) % 3;
            }

            applySort();
            updateHeaderArrows();
        }

        function applySort() {
            const table = document.getElementById('staffPerformanceTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            if (currentSort.state === 0) {
                // Reset to original order
                rows.sort((a, b) => (parseInt(a.getAttribute('data-original-index'))||0) - (parseInt(b.getAttribute('data-original-index'))||0));
                rows.forEach(r => tbody.appendChild(r));
                return;
            }

            const dir = currentSort.state === 1 ? 'desc' : 'asc';
            const comparator = buildComparator(currentSort.column, dir);
            rows.sort(comparator);
            rows.forEach(r => tbody.appendChild(r));
        }

        function buildComparator(sortKey, dir) {
            // Determine column index
            let colIndex = -1;
            if (sortKey === 'name') colIndex = 0;
            else if (sortKey === 'totalScans') colIndex = 1;
            else if (sortKey.startsWith('dept_')) {
                colIndex = 2 + getDepartmentIndex(sortKey); // departments start after 2 columns
            } else if (sortKey === 'returns') {
                // Not used, but keep mapping consistent if needed later
                colIndex = document.querySelectorAll('#staffPerformanceTable thead th').length - 2;
            }

            return (a, b) => {
                let aValue = 0, bValue = 0;
                if (colIndex >= 0) {
                    aValue = parseInt((a.cells[colIndex] && a.cells[colIndex].innerText) || '0') || 0;
                    bValue = parseInt((b.cells[colIndex] && b.cells[colIndex].innerText) || '0') || 0;
                }
                return dir === 'asc' ? aValue - bValue : bValue - aValue;
            };
        }

        function updateHeaderArrows() {
            const headers = document.querySelectorAll('#staffPerformanceTable th.sortable');
            headers.forEach(h => {
                if (h.getAttribute('data-sort') === currentSort.column) {
                    const state = currentSort.state === 1 ? 'up' : currentSort.state === 2 ? 'down' : 'none';
                    setHeaderArrow(h, state);
                } else {
                    setHeaderArrow(h, 'none');
                }
            });
        }

        function setHeaderArrow(header, state) {
            const icon = header.querySelector('i');
            if (!icon) return;
            if (state === 'up') {
                icon.className = 'fa-solid fa-sort-up text-primary';
            } else if (state === 'down') {
                icon.className = 'fa-solid fa-sort-down text-primary';
            } else {
                icon.className = 'fa-solid fa-sort text-muted';
            }
        }

        function setupUserManagement() {
            console.log('SETUP USER MANAGEMENT DEBUG: Setting up user management...');
            
            // Setup edit user buttons
            const editButtons = document.querySelectorAll('.edit-user-btn');
            console.log('SETUP USER MANAGEMENT DEBUG: Found', editButtons.length, 'edit buttons');
            
            editButtons.forEach((btn, index) => {
                console.log('SETUP USER MANAGEMENT DEBUG: Setting up edit button', index, 'with data:', {
                    userId: btn.getAttribute('data-user-id'),
                    userName: btn.getAttribute('data-user-name'),
                    userEmail: btn.getAttribute('data-user-email'),
                    userRole: btn.getAttribute('data-user-role'),
                    userDepartment: btn.getAttribute('data-user-department')
                });
                
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const userName = this.getAttribute('data-user-name');
                    const userEmail = this.getAttribute('data-user-email');
                    const userRole = this.getAttribute('data-user-role');
                    const userDepartment = this.getAttribute('data-user-department');
                    
                    console.log('SETUP USER MANAGEMENT DEBUG: Edit button clicked with data:', { userId, userName, userEmail, userRole, userDepartment });
                    editUser(userId, userName, userEmail, userRole, userDepartment);
                });
            });
            
            // Setup reset password buttons
            const resetButtons = document.querySelectorAll('.reset-password-btn');
            console.log('SETUP USER MANAGEMENT DEBUG: Found', resetButtons.length, 'reset buttons');
            
            resetButtons.forEach((btn, index) => {
                console.log('SETUP USER MANAGEMENT DEBUG: Setting up reset button', index, 'with data:', {
                    userId: btn.getAttribute('data-user-id'),
                    userName: btn.getAttribute('data-user-name')
                });
                
                btn.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const userName = this.getAttribute('data-user-name');
                    
                    console.log('SETUP USER MANAGEMENT DEBUG: Reset button clicked with data:', { userId, userName });
                    resetPassword(userId, userName);
                });
            });
        }

        function setupTableSorting() {
            const sortableHeaders = document.querySelectorAll('.sortable');
            
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const sortKey = this.getAttribute('data-sort');
                    handleSort(sortKey);
                });
            });
        }

        function handleSort(sortKey) {
            const table = document.getElementById('staffPerformanceTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Add loading state
            const loadingSpinner = document.createElement('div');
            loadingSpinner.className = 'position-absolute top-50 start-50 translate-middle';
            loadingSpinner.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
            table.style.position = 'relative';
            table.appendChild(loadingSpinner);
            
            // Update sort direction
            if (currentSort.column === sortKey) {
                // Subsequent clicks toggle direction
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // First click on a column should start with High to Low (descending)
                currentSort.column = sortKey;
                currentSort.direction = 'desc';
            }
            
            console.log('Sorting:', sortKey, 'Direction:', currentSort.direction, 'Full currentSort:', currentSort); // Debug log
            
            // Sort the rows
            rows.sort((a, b) => {
                let aValue, bValue;
                
                if (sortKey === 'name') {
                    aValue = a.cells[0].textContent.trim();
                    bValue = b.cells[0].textContent.trim();
                    return currentSort.direction === 'asc' ? 
                        aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                } else if (sortKey === 'totalScans') {
                    aValue = parseInt(a.cells[1].querySelector('span').textContent) || 0;
                    bValue = parseInt(b.cells[1].querySelector('span').textContent) || 0;
                    return currentSort.direction === 'asc' ? aValue - bValue : bValue - aValue;
                } else if (sortKey === 'returns') {
                    // Returns column - we'll sort by the button text or default to 0
                    aValue = 0; // Default value for returns
                    bValue = 0;
                    return currentSort.direction === 'asc' ? aValue - bValue : bValue - aValue;
                } else if (sortKey.startsWith('dept_')) {
                    // Department columns - get the department index
                    const deptIndex = getDepartmentIndex(sortKey);
                    if (deptIndex !== -1) {
                        aValue = parseInt(a.cells[deptIndex + 2].textContent) || 0;
                        bValue = parseInt(b.cells[deptIndex + 2].textContent) || 0;
                        return currentSort.direction === 'asc' ? aValue - bValue : bValue - aValue;
                    }
                }
                
                return 0;
            });
            
            // Reorder the table
            rows.forEach(row => tbody.appendChild(row));
            
            // Remove loading spinner
            const spinner = table.querySelector('.spinner-border');
            if (spinner) {
                spinner.parentElement.remove();
            }
            table.style.position = '';
            
            // Update sort indicators
            updateSortIndicators(sortKey);
            
            console.log('After sorting - currentSort:', currentSort); // Debug log
        }

        function getDepartmentIndex(sortKey) {
            // Scope strictly to this table's headers
            const headers = Array.from(document.querySelectorAll('#staffPerformanceTable th.sortable'));
            // Index of the clicked department header among all sortable headers
            const clickedIndex = headers.findIndex(h => h.getAttribute('data-sort') === sortKey);
            if (clickedIndex === -1) return -1;
            // First department header position among sortable headers
            const firstDeptIndex = headers.findIndex(h => (h.getAttribute('data-sort') || '').startsWith('dept_'));
            if (firstDeptIndex === -1) return -1;
            // Relative index of department column starting at 0
            return clickedIndex - firstDeptIndex;
        }

        function updateSortIndicators(sortKey) {
            // Reset all sort indicators
            document.querySelectorAll('.sortable i').forEach(icon => {
                icon.className = 'fa-solid fa-sort text-muted';
            });
            
            // Update the current sort indicator
            const currentHeader = document.querySelector(`[data-sort="${sortKey}"]`);
            if (currentHeader) {
                const icon = currentHeader.querySelector('i');
                if (currentSort.direction === 'asc') {
                    icon.className = 'fa-solid fa-sort-up text-primary';
                } else {
                    icon.className = 'fa-solid fa-sort-down text-primary';
                }
            }
            
            // Update sort info display
            updateSortInfoDisplay(sortKey);
        }

        function updateSortInfoDisplay(sortKey) {
            const currentSortInfo = document.getElementById('currentSortInfo');
            const sortColumnName = document.getElementById('sortColumnName');
            const sortDirection = document.getElementById('sortDirection');
            
            if (!sortKey) {
                currentSortInfo.style.display = 'none';
                return;
            }
            
            // Prefer the actual header text so display always matches the clicked column
            let columnDisplayName = '';
            const headerEl = document.querySelector(`[data-sort="${sortKey}"]`);
            if (headerEl) {
                const span = headerEl.querySelector('span');
                columnDisplayName = span ? span.textContent.trim() : '';
            }
            // Fallbacks
            if (!columnDisplayName) {
                if (sortKey === 'name') columnDisplayName = 'Name';
                else if (sortKey === 'totalScans') columnDisplayName = 'Total Scans';
                else if (sortKey === 'returns') columnDisplayName = 'Returns';
                else if (sortKey.startsWith('dept_')) columnDisplayName = sortKey.replace('dept_', '');
            }
            
            sortColumnName.textContent = columnDisplayName;
            sortDirection.textContent = currentSort.direction === 'asc' ? 'Low to High' : 'High to Low';
            currentSortInfo.style.display = 'inline';
        }

        function resetSort() {
            console.log('Reset called. Current sort before reset:', currentSort); // Debug log
            currentSort = { column: null, direction: 'asc' };
            
            // Reset all sort indicators
            document.querySelectorAll('.sortable i').forEach(icon => {
                icon.className = 'fa-solid fa-sort text-muted';
            });
            
            // Restore original row order without reloading
            const table = document.getElementById('staffPerformanceTable');
            if (table) {
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.sort((a, b) => {
                    const ai = parseInt(a.getAttribute('data-original-index') || '0', 10);
                    const bi = parseInt(b.getAttribute('data-original-index') || '0', 10);
                    return ai - bi;
                });
                rows.forEach(r => tbody.appendChild(r));
            }
            
            // Hide sort info
            const sortInfo = document.getElementById('currentSortInfo');
            if (sortInfo) sortInfo.style.display = 'none';
            
            console.log('Reset completed. Current sort after reset:', currentSort); // Debug log
        }
        
        // User Management Functions
        function showToast(message, type = 'success') {
            const toastId = type === 'success' ? 'successToast' : 'errorToast';
            const toastBodyId = type === 'success' ? 'successToastBody' : 'errorToastBody';
            
            document.getElementById(toastBodyId).textContent = message;
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
        }
        
        function editUser(userId, name, email, role, department) {
            console.log('EDIT USER DEBUG: Function called with:', { userId, name, email, role, department });
            
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserName').value = name;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserRole').value = role;
            document.getElementById('editUserDepartment').value = department;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }
        
        function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('editUserName').value;
            const email = document.getElementById('editUserEmail').value;
            const role = document.getElementById('editUserRole').value;
            const department = document.getElementById('editUserDepartment').value;
            const schedule = document.getElementById('editUserSchedule').value;
            
            console.log('SAVE USER CHANGES DEBUG: Saving changes for user:', { userId, name, email, role, department, schedule });
            
            // Basic validation
            if (!name.trim() || !email.trim()) {
                showToast('Name and email are required!', 'error');
                return;
            }
            
            // Parse schedule times
            const scheduleTimes = schedule ? schedule.split(',').map(s => s.trim()).filter(s => s) : [];
            
            const updates = {
                name: name,
                email: email,
                role: role,
                department: department,
                scheduleTimes: scheduleTimes
            };
            
            console.log('SAVE USER CHANGES DEBUG: Sending updates to backend:', updates);
            
            fetch(`/admin/users/${userId}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => {
                console.log('SAVE USER CHANGES DEBUG: Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('SAVE USER CHANGES DEBUG: Response data:', data);
                if (data.success) {
                    showToast('User updated successfully!', 'success');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                    modal.hide();
                    // Reload page to show updated data
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showToast('Error updating user: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('SAVE USER CHANGES DEBUG: Error:', error);
                showToast('Error updating user. Please try again.', 'error');
            });
        }
        
        function resetPassword(userId, userName) {
            console.log('RESET PASSWORD DEBUG: Function called with:', { userId, userName });
            const modalEl = document.getElementById('resetPasswordModal');
            // Populate fields (ensure these IDs exist)
            const idInput = document.getElementById('resetUserId') || document.getElementById('resetPasswordUserId');
            const nameInput = document.getElementById('resetUserName') || document.getElementById('resetPasswordUserName');
            if (idInput) idInput.value = userId;
            if (nameInput) nameInput.value ? nameInput.value = userName : nameInput.textContent = userName;
            const newPwdInput = modalEl.querySelector('#newPassword') || modalEl.querySelector('input[name="newPassword"]');
            const confirmPwdInput = modalEl.querySelector('#confirmPassword') || modalEl.querySelector('input[name="confirmPassword"]');
            if (newPwdInput) newPwdInput.value = '';
            if (confirmPwdInput) confirmPwdInput.value = '';
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
        
        function confirmPasswordReset() {
            const userId = document.getElementById('resetUserId').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            console.log('CONFIRM PASSWORD RESET DEBUG: Resetting password for user:', { userId, newPassword: '***', confirmPassword: '***' });
            
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match!', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('Password must be at least 6 characters long!', 'error');
                return;
            }
            
            const request = {
                newPassword: newPassword
            };
            
            console.log('CONFIRM PASSWORD RESET DEBUG: Sending request to backend for user ID:', userId);
            
            fetch(`/admin/users/${userId}/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(request)
            })
            .then(response => {
                console.log('CONFIRM PASSWORD RESET DEBUG: Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('CONFIRM PASSWORD RESET DEBUG: Response data:', data);
                if (data.success) {
                    showToast('Password reset successfully!', 'success');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
                    modal.hide();
                } else {
                    showToast('Error resetting password: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('CONFIRM PASSWORD RESET DEBUG: Error:', error);
                showToast('Error resetting password. Please try again.', 'error');
            });
        }
        
        // Simple date filter functionality - forms will submit naturally
        
        // Setup table sorting event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add click event listeners to sortable table headers
            document.querySelectorAll('#staffPerformanceTable th.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    handleSort(column);
                });
            });
            
            // Setup user management event listeners
            setupUserManagement();
            
                                // Simple date filter setup - forms submit naturally
        });
        // Build Staff Performance Horizontal Bar Chart
        (function() {
            try {
                var staffLabels = [
                    <!--/*--><th:block th:each="u,iter : ${users}">"[[${u.name}]]"[[${!iter.last ? ',' : ''}]]</th:block><!--*/-->
                ];
                var staffData = [
                    <!--/*--><th:block th:each="u,iter : ${users}">[[${scansByUser.get(u.id) != null ? scansByUser.get(u.id) : 0}]] [[${!iter.last ? ',' : ''}]]</th:block><!--*/-->
                ];
                var ctx = document.getElementById('staffPerfChart');
                if (ctx && typeof Chart !== 'undefined') {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: staffLabels,
                            datasets: [{
                                data: staffData,
                                backgroundColor: '#0d6efd'
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { beginAtZero: true, grid: { display: true } },
                                y: { ticks: { autoSkip: false } }
                            }
                        }
                    });
                }
            } catch (e) { console.error('Chart init error', e); }
        })();
        
        // Export table to CSV function
        function exportTableToCSV() {
            const table = document.getElementById('staffPerformanceTable');
            const rows = table.querySelectorAll('tr');
            let csv = [];
            
            // Process each row
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cols = row.querySelectorAll('td, th');
                let csvRow = [];
                
                for (let j = 0; j < cols.length; j++) {
                    const col = cols[j];
                    // Get text content and clean it up
                    let cellText = col.textContent.trim();
                    
                    // Remove extra whitespace and newlines
                    cellText = cellText.replace(/\s+/g, ' ');
                    
                    // Escape quotes and wrap in quotes if contains comma
                    if (cellText.includes(',') || cellText.includes('"') || cellText.includes('\n')) {
                        cellText = '"' + cellText.replace(/"/g, '""') + '"';
                    }
                    
                    csvRow.push(cellText);
                }
                
                csv.push(csvRow.join(','));
            }
            
            // Create CSV string
            const csvString = csv.join('\n');
            
            // Create download link
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            // Generate filename with current date
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(today.getDate()).padStart(2, '0');
            const filename = 'staff_performance_' + dateStr + '.csv';
            
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // Show success message
            showToast('CSV exported successfully!', 'success');
        }
    </script>
</body>
</html>
